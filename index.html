import React, { useState } from 'react';
import { Copy, Download, Lock, Unlock } from 'lucide-react';

const LuaObfuscator = () => {
  const [input, setInput] = useState('');
  const [output, setOutput] = useState('');
  const [options, setOptions] = useState({
    stringEncode: true,
    varRename: true,
    controlFlow: true,
    antiTamper: true,
    compression: true
  });

  const randomString = (length) => {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let result = '';
    for (let i = 0; i < length; i++) {
      result += chars[Math.floor(Math.random() * chars.length)];
    }
    return result;
  };

  const base64Encode = (str) => {
    return btoa(unescape(encodeURIComponent(str)));
  };

  const encodeString = (str) => {
    const encoded = str.split('').map(c => c.charCodeAt(0)).join(',');
    return `string.char(${encoded})`;
  };

  const obfuscate = () => {
    if (!input.trim()) {
      alert('Masukkan kode Lua terlebih dahulu!');
      return;
    }

    try {
      let code = input;
      const varMap = new Map();

      // Variable renaming
      if (options.varRename) {
        const keywords = ['and', 'break', 'do', 'else', 'elseif', 'end', 'false', 'for', 'function', 'if', 'in', 'local', 'nil', 'not', 'or', 'repeat', 'return', 'then', 'true', 'until', 'while'];
        const varPattern = /\b([a-zA-Z_][a-zA-Z0-9_]*)\b/g;
        const matches = [...code.matchAll(varPattern)];
        
        matches.forEach(match => {
          const varName = match[1];
          if (!keywords.includes(varName) && !varMap.has(varName)) {
            varMap.set(varName, `_0x${randomString(6)}`);
          }
        });

        varMap.forEach((newName, oldName) => {
          const regex = new RegExp(`\\b${oldName}\\b`, 'g');
          code = code.replace(regex, newName);
        });
      }

      // String encoding
      if (options.stringEncode) {
        const stringPattern = /["']([^"'\\]*(\\.[^"'\\]*)*)["']/g;
        code = code.replace(stringPattern, (match, p1) => {
          if (p1.length > 0) {
            return encodeString(p1);
          }
          return match;
        });
      }

      // Control flow obfuscation
      if (options.controlFlow) {
        const lines = code.split('\n');
        const obfLines = lines.map(line => {
          if (line.trim() && !line.trim().startsWith('--')) {
            return `do ${line} end`;
          }
          return line;
        });
        code = obfLines.join('\n');
      }

      // Compression
      if (options.compression) {
        code = code.replace(/\s+/g, ' ').replace(/\s*([{}();,])\s*/g, '$1');
      }

      // Wrapper with anti-tamper
      if (options.antiTamper) {
        const wrapperVars = {
          loader: `_0x${randomString(6)}`,
          checker: `_0x${randomString(6)}`,
          exec: `_0x${randomString(6)}`
        };

        const encoded = base64Encode(code);
        const wrapper = `
--[[ Advanced Obfuscation by KuramaMods ü¶ä ]]
local ${wrapperVars.loader}=(function()
local ${wrapperVars.checker}={${Array.from({length: 20}, () => Math.floor(Math.random() * 255)).join(',')}}
local function ${wrapperVars.exec}(s)
local r=''
for c in s:gmatch'.'do 
r=r..string.char(c:byte())
end
return r
end
return function(d)
local dec=''
for i=1,#d do
local b=d:sub(i,i)
dec=dec..b
end
return load(dec)
end
end)()
${wrapperVars.loader}([[${encoded}]])()`.trim();
        
        code = wrapper;
      }

      setOutput(code);
    } catch (error) {
      alert('Error saat obfuscation: ' + error.message);
    }
  };

  const copyToClipboard = () => {
    navigator.clipboard.writeText(output);
    alert('Kode berhasil disalin!');
  };

  const downloadFile = () => {
    const blob = new Blob([output], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'obfuscated.lua';
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-6">
      <div className="max-w-7xl mx-auto">
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-white mb-2 flex items-center justify-center gap-3">
            <Lock className="w-10 h-10 text-purple-400" />
            Advanced Lua Obfuscator
            <Lock className="w-10 h-10 text-purple-400" />
          </h1>
          <p className="text-purple-300">Proteksi kode Lua dengan enkripsi tingkat lanjut</p>
        </div>

        <div className="grid md:grid-cols-2 gap-6 mb-6">
          <div className="bg-slate-800/50 backdrop-blur rounded-lg p-6 border border-purple-500/30">
            <div className="flex items-center gap-2 mb-4">
              <Unlock className="w-5 h-5 text-green-400" />
              <h2 className="text-xl font-semibold text-white">Input Code</h2>
            </div>
            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              className="w-full h-96 bg-slate-900/50 text-green-300 font-mono text-sm p-4 rounded border border-purple-500/30 focus:border-purple-500 focus:outline-none resize-none"
              placeholder="-- Paste kode Lua Anda di sini
local function greet(name)
    print('Hello, ' .. name .. '!')
end

greet('World')"
            />
          </div>

          <div className="bg-slate-800/50 backdrop-blur rounded-lg p-6 border border-purple-500/30">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2">
                <Lock className="w-5 h-5 text-purple-400" />
                <h2 className="text-xl font-semibold text-white">Output Code</h2>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={copyToClipboard}
                  disabled={!output}
                  className="p-2 bg-purple-600 hover:bg-purple-700 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded transition"
                  title="Copy"
                >
                  <Copy className="w-4 h-4" />
                </button>
                <button
                  onClick={downloadFile}
                  disabled={!output}
                  className="p-2 bg-purple-600 hover:bg-purple-700 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded transition"
                  title="Download"
                >
                  <Download className="w-4 h-4" />
                </button>
              </div>
            </div>
            <textarea
              value={output}
              readOnly
              className="w-full h-96 bg-slate-900/50 text-purple-300 font-mono text-sm p-4 rounded border border-purple-500/30 resize-none"
              placeholder="Kode terobfuscate akan muncul di sini..."
            />
          </div>
        </div>

        <div className="bg-slate-800/50 backdrop-blur rounded-lg p-6 border border-purple-500/30 mb-6">
          <h3 className="text-lg font-semibold text-white mb-4">Opsi Obfuscation</h3>
          <div className="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
            {[
              { key: 'stringEncode', label: 'String Encoding', desc: 'Encode semua string' },
              { key: 'varRename', label: 'Variable Renaming', desc: 'Rename variabel' },
              { key: 'controlFlow', label: 'Control Flow', desc: 'Obfuscate alur kontrol' },
              { key: 'antiTamper', label: 'Anti-Tamper', desc: 'Proteksi anti-tamper' },
              { key: 'compression', label: 'Compression', desc: 'Kompresi kode' }
            ].map(opt => (
              <label key={opt.key} className="flex items-start gap-3 cursor-pointer group">
                <input
                  type="checkbox"
                  checked={options[opt.key]}
                  onChange={(e) => setOptions({...options, [opt.key]: e.target.checked})}
                  className="mt-1 w-4 h-4 accent-purple-600"
                />
                <div>
                  <div className="text-white font-medium group-hover:text-purple-300 transition">
                    {opt.label}
                  </div>
                  <div className="text-sm text-purple-400">{opt.desc}</div>
                </div>
              </label>
            ))}
          </div>
        </div>

        <div className="flex justify-center">
          <button
            onClick={obfuscate}
            className="px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold rounded-lg shadow-lg shadow-purple-500/50 transition transform hover:scale-105"
          >
            üîí Obfuscate Code
          </button>
        </div>

        <div className="mt-8 bg-slate-800/30 backdrop-blur rounded-lg p-4 border border-purple-500/20">
          <p className="text-sm text-purple-300 text-center">
            ‚ö†Ô∏è Disclaimer: Tool ini untuk tujuan edukasi. Pastikan Anda memiliki hak untuk mengobfuscate kode yang Anda gunakan.
          </p>
        </div>
      </div>
    </div>
  );
};

export default LuaObfuscator;
